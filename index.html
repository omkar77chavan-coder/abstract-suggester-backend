<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gaze-Based Abstract Generator</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    #camera-box {
      width: 320px; height: 240px;
      border: 3px solid black; margin: auto; position: relative;
      display: flex; align-items: center; justify-content: center;
    }
    video {
      width: 100%; height: 100%; object-fit: cover;
    }
    #gazeStatus { margin-top: 10px; font-weight: bold; }
    #output { margin-top: 20px; padding: 15px; border: 1px solid #ccc; min-height: 120px; }
    select, button { margin: 10px; padding: 6px 12px; font-size: 14px; }
    .green-ring { border: 3px solid green !important; }
    .red-ring { border: 3px solid red !important; }
  </style>
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
</head>
<body>
  <h1>Gaze-Based Abstract Generator</h1>

  <label for="academicLevel">Academic Level:</label>
  <select id="academicLevel">
    <option value="UG">UG</option>
    <option value="PG">PG</option>
  </select>

  <label for="stream">Stream:</label>
  <select id="stream">
    <option value="AI">AI</option>
    <option value="ML">ML</option>
    <option value="CSE">CSE</option>
    <option value="Cybersecurity">Cybersecurity</option>
    <option value="Data Science">Data Science</option>
    <option value="Electronics">Electronics</option>
  </select>

  <div id="camera-box">
    <video id="webcam" autoplay playsinline></video>
  </div>
  <div id="gazeStatus">Gaze status: Waiting...</div>

  <button id="generateBtn">Generate Abstract</button>

  <div id="output">
    <h3>Abstract:</h3>
    <p id="abstractText"></p>
    <h3>Conclusion:</h3>
    <p id="conclusionText"></p>
  </div>

  <script>
    let stableStart = null;
    let lastStatus = "none";

    // Access camera manually for alignment
    async function initCamera() {
      const video = document.getElementById("webcam");
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (err) {
        console.error("Camera access error:", err);
      }
    }
    initCamera();

    // Fake gaze detection logic (replace with actual webgazer detection if calibrated)
    function detectGaze() {
      // Example: randomly assign statuses for testing
      const statuses = ["centered", "off-center", "partial"];
      return statuses[Math.floor(Math.random() * statuses.length)];
    }

    async function fetchAbstract(level, stream, gaze) {
      const res = await fetch("http://127.0.0.1:5000/suggest", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ academicLevel: level, stream: stream, gazeStatus: gaze })
      });
      return await res.json();
    }

    async function updateOutput(level, stream, gaze) {
      const data = await fetchAbstract(level, stream, gaze);
      if (!data.error) {
        document.getElementById("abstractText").textContent = data.abstract;
        document.getElementById("conclusionText").textContent = data.conclusion;
      }
    }

    // Button backup
    document.getElementById("generateBtn").addEventListener("click", () => {
      const level = document.getElementById("academicLevel").value;
      const stream = document.getElementById("stream").value;
      updateOutput(level, stream, "manual");
    });

    // Continuous gaze check
    setInterval(() => {
      const status = detectGaze(); // Replace with actual gaze from webgazer
      const box = document.getElementById("camera-box");
      const level = document.getElementById("academicLevel").value;
      const stream = document.getElementById("stream").value;

      document.getElementById("gazeStatus").textContent = "Gaze status: " + status;

      if (status === "centered") {
        box.classList.add("green-ring"); box.classList.remove("red-ring");
        if (!stableStart) stableStart = Date.now();
        else if (Date.now() - stableStart > 3000 && lastStatus !== "centered") {
          updateOutput(level, stream, "centered");
          lastStatus = "centered";
        }
      } else {
        box.classList.add("red-ring"); box.classList.remove("green-ring");
        stableStart = null;

        if (status !== lastStatus) {
          updateOutput(level, stream, status);
          lastStatus = status;
        }
      }
    }, 1000);
  </script>
</body>
</html>
